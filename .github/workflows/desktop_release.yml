name: Compilar y Lanzar App Multiplataforma

on:
  push:
    tags:
      - 'v*'

jobs:
  build_windows_msi:
    name: Compilaci贸n - Windows MSI
    runs-on: windows-latest

    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-java@v4
        with:
          java-version: '17'
          distribution: 'temurin'
          cache: 'gradle'

      - name: Ejecutar Build para MSI
        run: .\gradlew.bat clean :composeApp:packageMsi
        shell: pwsh

      - name: Preparar y Guardar Artefacto
        run: |
          New-Item -ItemType Directory -Force -Path deployment-files
          Move-Item -Path composeApp/build/compose/binaries/main/msi/*.msi -Destination deployment-files/ProcessMonitor_Installer_Windows.msi
        shell: pwsh

      - name: Subir Artefacto MSI
        uses: actions/upload-artifact@v4
        with:
          name: deployment-windows-msi
          path: deployment-files/ProcessMonitor_Installer_Windows.msi

  build_linux_deb:
    name: Compilaci贸n - Linux DEB
    needs: build_windows_msi
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-java@v4
        with:
          java-version: '17'
          distribution: 'temurin'
          cache: 'gradle'

      - name: Instalar dependencias de Linux
        run: sudo apt-get update && sudo apt-get install -y fakeroot dpkg

      - name: Dar permisos de ejecuci贸n a gradlew
        run: chmod +x gradlew

      - name: Ejecutar Build para DEB
        run: ./gradlew clean :composeApp:packageDeb
        shell: bash

      - name: Preparar y Guardar Artefacto
        run: |
          mkdir -p deployment-files
          mv composeApp/build/compose/binaries/main/deb/*.deb deployment-files/ProcessMonitor_Package_Linux.deb

      - name: Subir Artefacto DEB
        uses: actions/upload-artifact@v4
        with:
          name: deployment-linux-deb
          path: deployment-files/ProcessMonitor_Package_Linux.deb

  create_github_release:
    name: Publicar Release
    needs: [build_windows_msi, build_linux_deb]
    runs-on: ubuntu-latest

    permissions:
      contents: write

    steps:
      - name: Crear directorio para artefactos
        run: mkdir -p release-assets

      - name: Descargar Artefacto Windows MSI
        uses: actions/download-artifact@v4
        with:
          name: deployment-windows-msi
          path: release-assets

      - name: Descargar Artefacto Linux DEB
        uses: actions/download-artifact@v4
        with:
          name: deployment-linux-deb
          path: release-assets

      - name: Listar archivos descargados (debug)
        run: ls -R release-assets

      - name: Publicar en GitHub Releases
        uses: softprops/action-gh-release@v1
        with:
          tag_name: ${{ github.ref_name }}
          name: Release Oficial ${{ github.ref_name }}
          body: |
             Lanzamiento de la versi贸n ${{ github.ref_name }}
            
            ## Instaladores disponibles:
            
            - **Windows**: `ProcessMonitor_Installer_Windows.msi`
            - **Linux**: `ProcessMonitor_Package_Linux.deb`
            
            ### Instalaci贸n:
            
            **Windows:**
            ```
            Doble clic en el archivo .msi
            ```
            
            **Linux (Debian/Ubuntu):**
            ```bash
            sudo dpkg -i ProcessMonitor_Package_Linux.deb
            ```
          files: release-assets/*
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}